// Fun√ß√£o para filtrar propostas - VERS√ÉO UNIFICADA
function filtrarPropostas() {
    console.log('üîç Executando filtrarPropostas (components/filters-sorting.js)');
    
    // Verificar se APP_STATE existe
    if (!window.APP_STATE || !Array.isArray(window.APP_STATE.propostas)) {
        console.warn('APP_STATE ou propostas n√£o dispon√≠veis');
        return [];
    }
    
    // Obter valores dos filtros
    const statusFiltro = document.getElementById('status-filter')?.value || 'todos';
    const cedenteFiltro = document.getElementById('cedente-filter')?.value?.toLowerCase() || '';
    const usuarioFiltro = document.getElementById('usuario-filter')?.value || 'todos';
    
    console.log(`Filtros aplicados - Status: ${statusFiltro}, Cedente: "${cedenteFiltro}", Usu√°rio: ${usuarioFiltro}`);
    
    // Filtrar propostas
    const resultado = window.APP_STATE.propostas.filter(proposta => {
        // Filtro de status
        let passaFiltroStatus = true;
        if (statusFiltro !== 'todos') {
            passaFiltroStatus = proposta.statusAtual === statusFiltro || proposta.statusSimplificado === statusFiltro;
        }
        
        // Filtro de cedente
        let passaFiltroCedente = true;
        if (cedenteFiltro !== '') {
            passaFiltroCedente = proposta.cedente.toLowerCase().includes(cedenteFiltro);
        }
        
        // Filtro de usu√°rio
        let passaFiltroUsuario = true;
        if (usuarioFiltro !== 'todos' && window.CedenteService && typeof window.CedenteService.cedenteAssociadoAoUsuario === 'function') {
            passaFiltroUsuario = window.CedenteService.cedenteAssociadoAoUsuario(proposta.cedente, usuarioFiltro);
        }
        
        return passaFiltroStatus && passaFiltroCedente && passaFiltroUsuario;
    });
    
    console.log(`Filtro conclu√≠do: ${resultado.length} de ${window.APP_STATE.propostas.length} propostas`);
    return resultado;
}

// Fun√ß√£o para ordenar propostas - VERS√ÉO UNIFICADA
function ordenarPropostas(propostas) {
    console.log('üìä Executando ordenarPropostas (components/filters-sorting.js)');
    
    if (!Array.isArray(propostas)) {
        console.error("ordenarPropostas: propostas n√£o √© um array");
        return [];
    }
    
    // Obter crit√©rio de ordena√ß√£o
    const ordenacao = window.APP_STATE?.ordenacao || 'data_desc';
    console.log(`Ordenando por: ${ordenacao}`);
    
    // Criar c√≥pia para n√£o modificar o original
    const propostasOrdenadas = [...propostas];
    
    // Fun√ß√µes auxiliares para compara√ß√£o
    const compareDates = (a, b) => {
        if (!a && !b) return 0;
        if (!a) return 1;
        if (!b) return -1;
        return new Date(a) - new Date(b);
    };
    
    const compareNumbers = (a, b) => {
        if (a === null && b === null) return 0;
        if (a === null) return 1;
        if (b === null) return -1;
        return a - b;
    };
    
    // Aplicar ordena√ß√£o
    switch (ordenacao) {
        case 'data_desc':
            propostasOrdenadas.sort((a, b) => compareDates(b.data, a.data));
            break;
        case 'data_asc':
            propostasOrdenadas.sort((a, b) => compareDates(a.data, b.data));
            break;
        case 'tempo_total_desc':
            propostasOrdenadas.sort((a, b) => compareNumbers(b.tempoTotal, a.tempoTotal));
            break;
        case 'tempo_total_asc':
            propostasOrdenadas.sort((a, b) => compareNumbers(a.tempoTotal, b.tempoTotal));
            break;
        case 'hora_entrada_desc':
            propostasOrdenadas.sort((a, b) => compareDates(b.horaEntrada, a.horaEntrada));
            break;
        case 'hora_entrada_asc':
            propostasOrdenadas.sort((a, b) => compareDates(a.horaEntrada, b.horaEntrada));
            break;
        case 'numero_desc':
            propostasOrdenadas.sort((a, b) => parseInt(b.numero) - parseInt(a.numero));
            break;
        case 'numero_asc':
            propostasOrdenadas.sort((a, b) => parseInt(a.numero) - parseInt(b.numero));
            break;
        case 'cedente_asc':
            propostasOrdenadas.sort((a, b) => a.cedente.localeCompare(b.cedente));
            break;
        case 'cedente_desc':
            propostasOrdenadas.sort((a, b) => b.cedente.localeCompare(a.cedente));
            break;
        case 'analise_desc':
            propostasOrdenadas.sort((a, b) => compareDates(b.horaAnalise, a.horaAnalise));
            break;
        case 'analise_asc':
            propostasOrdenadas.sort((a, b) => compareDates(a.horaAnalise, b.horaAnalise));
            break;
        case 'checagem_desc':
            propostasOrdenadas.sort((a, b) => compareDates(b.horaChecagem, a.horaChecagem));
            break;
        case 'checagem_asc':
            propostasOrdenadas.sort((a, b) => compareDates(a.horaChecagem, b.horaChecagem));
            break;
        case 'certificacao_desc':
            propostasOrdenadas.sort((a, b) => compareDates(b.horaCertifica, a.horaCertifica));
            break;
        case 'certificacao_asc':
            propostasOrdenadas.sort((a, b) => compareDates(a.horaCertifica, b.horaCertifica));
            break;
        case 'pagamento_desc':
            propostasOrdenadas.sort((a, b) => compareDates(b.horaPagamento, a.horaPagamento));
            break;
        case 'pagamento_asc':
            propostasOrdenadas.sort((a, b) => compareDates(a.horaPagamento, b.horaPagamento));
            break;
        case 'pendencia_desc':
            propostasOrdenadas.sort((a, b) => compareDates(b.horaPendencia, a.horaPendencia));
            break;
        case 'pendencia_asc':
            propostasOrdenadas.sort((a, b) => compareDates(a.horaPendencia, b.horaPendencia));
            break;
        case 'status_asc':
            propostasOrdenadas.sort((a, b) => (a.pesoStatus || 0) - (b.pesoStatus || 0));
            break;
        case 'status_desc':
            propostasOrdenadas.sort((a, b) => (b.pesoStatus || 0) - (a.pesoStatus || 0));
            break;
        default:
            console.warn(`Crit√©rio de ordena√ß√£o desconhecido: ${ordenacao}`);
            propostasOrdenadas.sort((a, b) => compareDates(b.data, a.data));
    }
    
    console.log(`Ordena√ß√£o conclu√≠da: ${propostasOrdenadas.length} propostas ordenadas por ${ordenacao}`);
    return propostasOrdenadas;
}

// Fun√ß√£o para aplicar filtros e ordena√ß√£o
function aplicarFiltrosEOrdenacao() {
    console.log('üîÑ Aplicando filtros e ordena√ß√£o...');
    
    try {
        // Filtrar propostas
        const propostasFiltradas = filtrarPropostas();
        
        // Ordenar propostas filtradas
        const propostasOrdenadas = ordenarPropostas(propostasFiltradas);
        
        // Renderizar tabela
        if (typeof window.renderizarTabela === 'function') {
            window.renderizarTabela(propostasOrdenadas);
        } else {
            console.error('Fun√ß√£o renderizarTabela n√£o encontrada');
        }
        
        // Atualizar estat√≠sticas
        if (typeof window.atualizarEstatisticas === 'function') {
            window.atualizarEstatisticas(propostasFiltradas);
        }
        
        // Atualizar opera√ß√µes excedidas
        if (typeof window.atualizarOperacoesExcedidas === 'function') {
            window.atualizarOperacoesExcedidas(propostasFiltradas);
        }
        
        console.log('‚úÖ Filtros e ordena√ß√£o aplicados com sucesso');
        
    } catch (error) {
        console.error('‚ùå Erro ao aplicar filtros e ordena√ß√£o:', error);
    }
}

// Fun√ß√£o para configurar event listeners dos filtros
function configurarEventListenersFiltros() {
    console.log('üéõÔ∏è Configurando event listeners dos filtros...');
    
    // Filtro de status
    const statusFilter = document.getElementById('status-filter');
    if (statusFilter) {
        statusFilter.addEventListener('change', function() {
            if (window.APP_STATE) {
                window.APP_STATE.filtroStatus = this.value;
            }
            console.log(`Status filtro alterado para: ${this.value}`);
            aplicarFiltrosEOrdenacao();
        });
    }
    
    // Filtro de cedente
    const cedenteFilter = document.getElementById('cedente-filter');
    if (cedenteFilter) {
        cedenteFilter.addEventListener('input', function() {
            if (window.APP_STATE) {
                window.APP_STATE.filtroCedente = this.value;
            }
            console.log(`Cedente filtro alterado para: "${this.value}"`);
            aplicarFiltrosEOrdenacao();
        });
    }
    
    // Filtro de usu√°rio
    const usuarioFilter = document.getElementById('usuario-filter');
    if (usuarioFilter) {
        usuarioFilter.addEventListener('change', function() {
            if (window.APP_STATE) {
                window.APP_STATE.usuarioSelecionado = this.value;
            }
            console.log(`Usu√°rio filtro alterado para: ${this.value}`);
            aplicarFiltrosEOrdenacao();
        });
    }
    
    console.log('‚úÖ Event listeners dos filtros configurados');
}

// Fun√ß√£o para configurar ordena√ß√£o por clique nos cabe√ßalhos
function configurarOrdenacaoPorCabecalho() {
    console.log('üìã Configurando ordena√ß√£o por cabe√ßalho...');
    
    // Remover event listeners existentes
    document.querySelectorAll('.sortable').forEach(header => {
        const newHeader = header.cloneNode(true);
        header.parentNode.replaceChild(newHeader, header);
    });
    
    // Adicionar novos event listeners
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', function() {
            const sortType = this.getAttribute('data-sort');
            console.log(`Clicou no cabe√ßalho: ${sortType}`);
            
            if (!sortType) {
                console.warn('Tipo de ordena√ß√£o n√£o definido para este cabe√ßalho');
                return;
            }
            
            // Determinar dire√ß√£o da ordena√ß√£o
            let novaOrdenacao = sortType + '_desc';
            
            if (window.APP_STATE && window.APP_STATE.ordenacao === sortType + '_desc') {
                novaOrdenacao = sortType + '_asc';
            }
            
            // Atualizar estado
            if (window.APP_STATE) {
                window.APP_STATE.ordenacao = novaOrdenacao;
            }
            
            console.log(`Ordena√ß√£o alterada para: ${novaOrdenacao}`);
            
            // Atualizar indicadores visuais
            document.querySelectorAll('.sortable').forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });
            
            if (novaOrdenacao.endsWith('_asc')) {
                this.classList.add('sort-asc');
            } else {
                this.classList.add('sort-desc');
            }
            
            // Aplicar ordena√ß√£o
            aplicarFiltrosEOrdenacao();
        });
        
        // Adicionar cursor pointer
        header.style.cursor = 'pointer';
    });
    
    console.log('‚úÖ Ordena√ß√£o por cabe√ßalho configurada');
}

// Expor fun√ß√µes globalmente
window.filtrarPropostas = filtrarPropostas;
window.ordenarPropostas = ordenarPropostas;
window.aplicarFiltrosEOrdenacao = aplicarFiltrosEOrdenacao;
window.configurarEventListenersFiltros = configurarEventListenersFiltros;
window.configurarOrdenacaoPorCabecalho = configurarOrdenacaoPorCabecalho;

// Configurar automaticamente quando o DOM estiver pronto
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            configurarEventListenersFiltros();
            configurarOrdenacaoPorCabecalho();
        }, 1000);
    });
} else {
    setTimeout(() => {
        configurarEventListenersFiltros();
        configurarOrdenacaoPorCabecalho();
    }, 1000);
}

console.log('‚úÖ Filters and Sorting carregado');